<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>88-Key Piano Keyboard</title>
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/piano-styles.css" />
    <link rel="stylesheet" href="css/midonika.css" />
    <link rel="stylesheet" href="css/chord-display.css" />
      <link rel="stylesheet" href="css/zoomed-keyboard.css" />
      <link rel="stylesheet" href="css/chord-selector.css" />
  </head>
  <body>
    <header>Tonika I</header>

    <main>
      <!-- Top Tab Group -->

      <section class="tab-group top-tabs">
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="1">Chord Display</button>
          <button class="tab-btn" data-tab="2">Tab 2</button>
          <button class="tab-btn" data-tab="3">Tab 3</button>
          <button class="tab-btn" data-tab="4">Tab 4</button>
          <button class="tab-btn" data-tab="5">Tab 5</button>
          <button class="tab-btn" data-tab="6">Midi Info</button>
        </div>

          <div class="tab-content" data-tab="1">
              <div class="chord-panel">
                  <div class="chord-panel-top">
                      <div class="chord-panel-left">
                          <div id="chord-selector-container"></div>
                      </div>
                      <div class="chord-panel-right">
                          <div id="zoomed-keyboard-container"></div>
                      </div>
                  </div>
                  <div class="chord-panel-bottom">
                      <div id="chord-display-container">
                          <div id="chord-display"></div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="tab-content hidden" data-tab="2">Content for Tab 2</div>
          <div class="tab-content hidden" data-tab="3">Content for Tab 3</div>
          <div class="tab-content hidden" data-tab="4">Content for Tab 4</div>
          <div class="tab-content hidden" data-tab="5">Content for Tab 5</div>
          <div class="tab-content hidden" data-tab="6">
              <div id="midonika-container" class="midonika-wrap"></div>
          </div>
      </section>

      <section class="piano-wrapper">
        <div class="midi-device-label">
          <label for="midiDeviceSelector">ðŸŽ› Select MIDI Input:</label>
          <select id="midiDeviceSelector"></select>
        </div>
        <div class="piano-controls">
          <label>
            <input type="checkbox" id="toggleCOnly" />
            Show only C notes
          </label>
          <label>
            <input type="checkbox" id="toggleAllLabels" />
            Hide all note labels
          </label>
          <label class="middle-c-label">
            <span>Middle C Label:</span>
            <select id="middleC">
              <option value="C3" selected>
                C3 (Kawai VPC1, Yamaha, Logic)
              </option>
              <option value="C4">C4 (Midonika, General MIDI)</option>
              <option value="C5">C5 (Notation, FL Studio)</option>
            </select>
          </label>
        </div>

        <div class="piano-container">
          <div class="keyboard" id="keyboard"></div>
        </div>
      </section>

      <!-- Bottom Tab Group -->

      <section class="tab-group bottom-tabs">
        <div class="tab-nav">
          <button class="tab-btn" data-tab="b1">Tab 1</button>
          <button class="tab-btn" data-tab="b2">Tab 2</button>
          <button class="tab-btn" data-tab="b3">Tab 3</button>
          <button class="tab-btn" data-tab="b4">Tab 4</button>
          <button class="tab-btn" data-tab="b5">Tab 5</button>
          <button class="tab-btn" data-tab="b6">Tab 6</button>
        </div>

        <div class="tab-content hidden" data-tab="b1">Content for Tab 1</div>
        <div class="tab-content hidden" data-tab="b2">Content for Tab 2</div>
        <div class="tab-content hidden" data-tab="b3">Content for Tab 3</div>
        <div class="tab-content hidden" data-tab="b4">Content for Tab 4</div>
        <div class="tab-content hidden" data-tab="b5">Content for Tab 5</div>
        <div class="tab-content hidden" data-tab="b6">Content for Tab 6</div>
      </section>
    </main>

    <footer>Footer</footer>
    <!-- Everything above this is unchanged -->

    <script src="js/midonika.iife.js"></script>
    <script src="js/tabs.js"></script>
    <script src="js/piano.js"></script>
    <script src="js/midibridge.js"></script>

    <!-- New chord analysis scripts -->
    <script src="js/midi-api-bridge.js"></script>
    <script src="js/chord-analyzer.js"></script>
    <script src="js/chord-display.js"></script>
    <script src="js/chord-selector.js"></script>
    <script src="js/zoomed-keyboard.js"></script>

    <script>
        let midonikaApp = null;
        let _chordSetupDone = false;

        // Make these global for debugging
        window.chordSelector = null;
        window.zoomedKeyboard = null;

        // Function to set up chord detection
        function setupChordDetection() {
            if (_chordSetupDone) return; // Prevent duplicate setup
            _chordSetupDone = true;

            const chordAnalyzer = new ChordAnalyzer();
            const chordDisplay = new ChordDisplay("#chord-display");

            // Initialize chord selector and zoomed keyboard
            window.chordSelector = new ChordSelector("#chord-selector-container");
            window.zoomedKeyboard = new ZoomedKeyboard("#zoomed-keyboard-container");

            // Connect chord selector to zoomed keyboard
            window.chordSelector.setChordSelectedCallback((chord) => {
                window.zoomedKeyboard.displayChord(chord);
            });

            // Update zoomed keyboard when Middle C mapping changes
            const middleCSelect = document.querySelector('#middleC');
            if (middleCSelect) {
                middleCSelect.addEventListener('change', (e) => {
                    window.zoomedKeyboard.updateMiddleCMapping(e.target.value);
                });
                // Set initial mapping
                window.zoomedKeyboard.updateMiddleCMapping(middleCSelect.value);
            }

            // Hook directly into the existing piano interface
            const originalNoteOn = window.PianoInterface.noteOn;
            const originalNoteOff = window.PianoInterface.noteOff;

            let activeNotes = new Set();

            // Override noteOn to add chord analysis
            window.PianoInterface.noteOn = function (midiNote) {
                // Call original function first (keeps piano working)
                originalNoteOn.call(this, midiNote);

                // Add to active notes and analyze
                activeNotes.add(midiNote);
                analyzeCurrentChord();
            };

            // Override noteOff to update chord analysis
            window.PianoInterface.noteOff = function (midiNote) {
                // Call original function first (keeps piano working)
                originalNoteOff.call(this, midiNote);

                // Remove from active notes and re-analyze
                activeNotes.delete(midiNote);
                analyzeCurrentChord();
            };

            function analyzeCurrentChord() {
                if (activeNotes.size >= 2) {
                    const chord = chordAnalyzer.analyzeNotes(
                        Array.from(activeNotes),
                    );
                    console.log("ðŸŽµ Chord detected:", chord);
                    chordDisplay.updateChord(chord);
                } else {
                    chordDisplay.clearDisplay();
                }
            }

            console.log("âœ… Chord analysis connected to piano interface");
            console.log("âœ… Chord selector and zoomed keyboard initialized");
        }

        // ðŸŽ¹ Launch Midonika immediately so it's ready for all tabs
        window.addEventListener("DOMContentLoaded", () => {
            midonikaApp = Midonika.createMidonika("#midonika-container");

            // Set up chord detection immediately since Tab 1 is active by default
            setupChordDetection();

            // ðŸ§  Tab switch handler
            document.querySelectorAll(".tab-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const tabId = btn.dataset.tab;

                    // If switching to Tab 1, ensure chord detection is set up
                    if (tabId === "1") {
                        setupChordDetection();
                    }
                });
            });
        });
    </script>
  </body>
</html>
